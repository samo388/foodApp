name: FoodApp CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    # =========================
    # 1Ô∏è‚É£ Checkout Code
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================
    # 2Ô∏è‚É£ Login to DockerHub
    # =========================
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # =========================
    # 3Ô∏è‚É£ Build & Push Backend
    # =========================
    - name: Build and Push Backend Image
      run: |
        docker build -t sam840/foodapp-backend:latest ./backend
        docker push sam840/foodapp-backend:latest

    # =========================
    # 4Ô∏è‚É£ Build & Push Frontend
    # =========================
    - name: Build and Push Frontend Image
      run: |
        docker build -t sam840/foodapp-frontend:latest ./frontend
        docker push sam840/foodapp-frontend:latest

    # =========================
    # 5Ô∏è‚É£ Setup kubectl
    # =========================
    - name: Setup kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: v1.29.0

    # =========================
    # 6Ô∏è‚É£ Configure kubeconfig
    # =========================
    - name: Configure Kubernetes access
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config

    # =========================
    # 7Ô∏è‚É£ Deploy MongoDB
    # =========================
    - name: Deploy MongoDB
      run: |
        kubectl apply -f k8s/mongo-pvc.yaml
        kubectl apply -f k8s/mongo-deployment.yaml
        kubectl apply -f k8s/mongo-service.yaml

    # =========================
    # 8Ô∏è‚É£ Deploy Backend
    # =========================
    - name: Deploy Backend
      run: |
        kubectl apply -f k8s/backend-deployment.yaml
        kubectl apply -f k8s/backend-service.yaml

    # =========================
    # 9Ô∏è‚É£ Run Seed Job
    # =========================
    - name: Seed Database
      run: |
        kubectl apply -f k8s/seed-job.yaml

    # =========================
    # üîü Deploy Frontend
    # =========================
    - name: Deploy Frontend
      run: |
        kubectl apply -f k8s/frontend-deployment.yaml
        kubectl apply -f k8s/frontend-service.yaml

    # =========================
    # 1Ô∏è‚É£1Ô∏è‚É£ Deploy Ingress
    # =========================
    - name: Deploy Ingress
      run: |
        kubectl apply -f k8s/ingress.yaml
