name: FoodApp CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_USERNAME: sam840
  BACKEND_IMAGE: sam840/foodapp-backend
  FRONTEND_IMAGE: sam840/foodapp-frontend

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Debug paths (IMPORTANT)
      # -------------------------
      - name: Debug repo structure
        run: |
          ls -la
          ls -la FOODAPP
          ls -la FOODAPP/k8s

      # -------------------------
      # Docker Login
      # -------------------------
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # -------------------------
      # Build & Push Backend
      # -------------------------
      - name: Build and Push Backend Image
        run: |
          docker build -t $BACKEND_IMAGE:latest ./FOODAPP/backend
          docker push $BACKEND_IMAGE:latest

      # -------------------------
      # Build & Push Frontend
      # -------------------------
      - name: Build and Push Frontend Image
        run: |
          docker build -t $FRONTEND_IMAGE:latest ./FOODAPP/frontend
          docker push $FRONTEND_IMAGE:latest

      # -------------------------
      # Setup kubectl
      # -------------------------
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      # -------------------------
      # Configure kubeconfig
      # -------------------------
      - name: Configure Kubernetes access
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config

      # -------------------------
      # Deploy MongoDB
      # -------------------------
      - name: Deploy MongoDB
        run: |
          kubectl apply -f FOODAPP/k8s/mongo-pvc.yaml
          kubectl apply -f FOODAPP/k8s/mongo-deployment.yaml
          kubectl apply -f FOODAPP/k8s/mongo-service.yaml

      # -------------------------
      # Deploy Backend
      # -------------------------
      - name: Deploy Backend
        run: |
          kubectl apply -f FOODAPP/k8s/backend-deployment.yaml
          kubectl apply -f FOODAPP/k8s/backend-service.yaml

      # -------------------------
      # Seed Database
      # -------------------------
      - name: Seed Database
        run: |
          kubectl apply -f FOODAPP/k8s/seed-job.yaml

      # -------------------------
      # Deploy Frontend
      # -------------------------
      - name: Deploy Frontend
        run: |
          kubectl apply -f FOODAPP/k8s/frontend-deployment.yaml
          kubectl apply -f FOODAPP/k8s/frontend-service.yaml

      # -------------------------
      # Deploy Ingress
      # -------------------------
      - name: Deploy Ingress
        run: |
          kubectl apply -f FOODAPP/k8s/ingress.yaml
